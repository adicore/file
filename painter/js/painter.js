function client2Local(a,b){b.x=parseInt(a.clientX-$("#painter").offset().left+$(document).scrollLeft()),b.y=parseInt(a.clientY-$("#painter").offset().top+$(document).scrollTop())}function signCmd(a){if(-1!=a.indexOf("Sign In"))driveClient.doAuth(!0,"app",void 0);else if(-1!=a.indexOf("Sign Out")){var b=$("#menuUser");b.remove(),b=$('<ul id="menuUser" style="z-index:999"/>'),$(document.body).append(b),b.html("").addClass("notranslate").menu().hide().css("position","absolute"),$("ul#menuUser li").click(function(){signCmd($(this).text())}),$("#btnUser .ui-button-text").text("Sign In"),driveClient.signOut(),updateAds()}else-1!=a.indexOf("Upgrade Account")?updatePremium(driveClient):driveClient.showAccountInfo()}function updateLoginInfo(){if(console.log("updateLoginInfo"),driveClient){if(driveClient.isSignIn("app")){$("#btnUser .ui-button-text").text("User");var a=$("#menuUser");a.remove(),a=$('<ul id="menuUser" style="z-index:999"/>'),$(document.body).append(a),a.html(getMenuHtml([driveClient.userinfo.email,"Account Info","Upgrade Account","Sign Out"])).addClass("notranslate").menu().hide().css("position","absolute"),$("ul#menuUser li").click(function(){signCmd($(this).text())}),driveClient.settings.signIn=!0}else{var b=driveClient.getDriveObj(driveClient.type);b&&(b.signIn=!1),$("#btnUser .ui-button-text").text("Sign In"),driveClient.settings.signIn=!1}console.log("updateLoginInfo 1",driveClient.settings.signIn),updateAds()}}function updateAds(){if(void 0!=driveClient.settings.ads&&void 0!=driveClient.settings.signIn){if(showAds=!1,!driveClient||!driveClient.settings.ads||driveClient.settings.signIn&&driveClient.isPremium()||(showAds=!0),showAds)if(adsInited)$(".adsbygoogle").css({display:"inline-block"});else{var a=$('<div id="googleAds"/>');$("#content_paint").append(a),a.css({position:"absolute",top:"40px",right:"20px",width:"162px",height:"602px"});var b=document.createElement("script");b.type="text/javascript",b.setAttribute("async","async"),b.src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js",a[0].appendChild(b);var c=document.createElement("ins");c.setAttribute("class","adsbygoogle"),c.setAttribute("style","display:inline-block;width:160px;height:600px"),c.setAttribute("data-ad-client","ca-pub-3312637127877426"),c.setAttribute("data-ad-slot","6330440569"),a[0].appendChild(c);var d=document.createElement("script");d.type="text/javascript",d.text="(adsbygoogle = window.adsbygoogle || []).push({});",a[0].appendChild(d),adsInited=!0}else $(".adsbygoogle").css({display:"none"});adjustPaint(),console.log("show Ads",showAds)}}function openSuccessful(result){if(!result.startWith("Cannot find request url:")){var proj=eval("("+result+")");isJson(proj)&&project.setProject(proj),window.setInterval("tryToSaveProject(true,false)",3e5)}}function openFailed(){alert("Error open project"),window.setInterval("tryToSaveProject(true,false)",3e5)}function tryToSaveProject(a,b){if(project.modify&&!project.onSaving){project.onSaving=!0,project.painter.data=project.stackDatas[project.curStack].src;var c=JSON.stringify(project.painter);saveProject(userID,fileName,"yip",c,a,b,saveSuccessful,saveFailed)}}function saveSuccessful(){project.onSaving=!1,project.modify=!1}function saveFailed(a){project.onSaving=!1,a&&alert("Uploaded failed!")}function banBackSpace(a){var b=a||window.event,c=b.target||b.srcElement,d=c.type||c.getAttribute("type"),e=c.readOnly,f=c.disabled;e=void 0==e?!1:e,f=void 0==f?!0:f;var g=!("password"!=d&&"text"!=d&&"textarea"!=d||1!=e&&1!=f),h="password"!=d&&"text"!=d&&"textarea"!=d;if(h||g){var i=getKeyAction(b);if(""!=i)return"Undo"==i||"Redo"==i?menuSelect(i):menuContextSelect(i),!1}return!0}function fullScreen(a){a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen&&a.mozRequestFullScreen()}function initFonts(){$("#cmbfont").html('<option value="Arial">Arial</option> 	<option value="Arial Black">Arial Black</option> 	<option value="Arial Narrow">Arial Narrow</option> 	<option value="Verdana">Verdana</option> 	<option value="Georgia">Georgia</option> 	<option value="Times New Roman">Times New Roman</option> 	<option value="Trebuchet MS">Trebuchet MS</option> 	<option value="Impact">Impact</option> 	<option value="Comic Sans MS">Comic Sans MS</option> 	<option value="Tahoma">Tahoma</option> 	<option value="Courier">Courier</option> 	<option value="Courier New">Courier New</option> 	<option value="Lucida Sans Unicode">Lucida Sans Unicode</option> 	<option value="Lucida Console">Lucida Console</option> 	<option value="Garamond">Garamond</option> 	<option value="MS Sans Serif">MS Sans Serif</option> 	<option value="MS Serif">MS Serif</option> 	<option value="Palatino Linotype">Palatino Linotype</option> 	<option value="Symbol">Symbol</option> 	<option value="Bookman Old Style">Bookman Old Style</option> 	')}function getKeyAction(a){if(13==a.which)return"Crop";if((8==a.which||46==a.which)&&0==$("#edText").is(":visible"))return"Delete";var b=!1;if(1==mac){if(90==a.which){if(a.metaKey&&a.shiftKey)return"Redo";if(a.metaKey)return"Undo"}b=a.metaKey}else{if(90==a.which&&a.ctrlKey)return"Undo";if(89==a.which&&a.ctrlKey)return"Redo";b=a.ctrlKey}return 67==a.which&&b?"Copy":86==a.which&&b?"Paste":88==a.which&&b?"Cut":65==a.which&&b?"Select All":83==a.which&&b?"Save":""}function menuContextSelect(a){return"Save"==a?(project.saveImage("png"),void project.initCanvas(!1)):("Crop"==a?project.cropCatch():"Delete"==a?project.removeCatch():"Copy"==a?project.copyCutClip(!1):"Paste"==a?project.pasteClip():"Cut"==a?project.copyCutClip(!0):"Select All"==a&&(toolClick("select"),project.selectAll()),void $("#menuContext").hide())}function menuSelect(a){if(project.mergeCatch(!0),"New Image"==a)$().w2popup("load",{url:"newImage.html",onOpen:function(){$("#edImageWidth").val(640),$("#edImageHeight").val(480)}});else if("Open Image"==a)addImage=!1,$("#fileSelect").trigger("click");else if("Open Image URL"==a)$().w2popup("load",{url:"openURL.html"});else if("Export"==a)project.saveImage("png"),project.initCanvas(!1);else if("Print"==a){var b,c={pageTitle:"YouiDraw"};b=$("<img width="+project.painter.width+" height="+project.painter.height+"></img>");var d=project.divCanvas.toDataURL("image/png");b.attr("src",d),b.printThis(c)}else if("Clear"==a)tool.paintTemplate(0,0,"clearPath"),project.context.clearRect(0,0,project.divCanvas.width,project.divCanvas.height),project.saveStack();else if("Image Size"==a)$().w2popup("load",{url:"canvasSize.html",onOpen:function(){$("#edImageWidth").val(project.painter.width),$("#edImageHeight").val(project.painter.height)}});else if("Undo"==a)project.undo();else if("Redo"==a)project.redo();else if("User Guide"==a)window.open("http://site.youidraw.com/youidraw-painter-user-guide.html","_blank","",!0);else if("Home Page"==a)window.open("/","_blank","",!0);else{if("Feedback"!=a)return;window.open(encodeURI("https://mail.google.com/mail/?view=cm&fs=1&to=support@youidraw.com&su=Feedback of Youidraw Painter&body=Hi YouiDraw,"),"_blank","",!0)}$("#menuMain").hide()}function brushChange(a){if(void 0!=a){var b="brush"+padLeft(a+1,2,"0")+".png";originBrush.src!="https://www.youidraw.com/apps/painter/assets/brush/"+b&&($("#imgBrush").css("background","url(https://www.youidraw.com/apps/painter/assets/brush/"+b+")").css("background-size","100% 100%"),originBrush.src="https://www.youidraw.com/apps/painter/assets/brush/"+b),setting.brush.index=a,$("#moreBrush").hide()}$("ul#moreBrush > li").each(function(){$(this).index()==setting.brush.index?$(this).addClass("liselected"):$(this).removeClass("liselected")})}function shapeChange(a){void 0!=a&&(setting.shape.index=a,setting.shape.type=project.getShape(a),$("#imgShape").attr("class","icons24 icon_"+setting.shape.type+"24"),adjustPropertiesLayout(),project.drawCatch()),$("ul#moreShape > li").each(function(){$(this).index()==setting.shape.index?$(this).addClass("liselected"):$(this).removeClass("liselected")})}function pencilChange(){changeTool()}function fontChange(){toolProp.font.family=$("#cmbfont").val(),project.drawCatch()}function sizeChange(){setValue||void 0==tool||("text"==curTool?toolProp.font.size=$("#edSize").val():toolProp.size[tool.styleName]=$("#edSize").val(),project.drawCatch())}function borderSizeChange(){setValue||void 0==tool||(toolProp.size[curTool]=$("#edBorderSize").val(),project.drawCatch())}function spaceChange(){setValue||void 0==tool||(toolProp.space[tool.styleName]=$("#edSpace").val())}function lengthChange(){setValue||void 0==tool||(toolProp.length[tool.styleName]=$("#edLength").val()/100)}function opacityChange(){if(!setValue&&void 0!=tool){var a=tool.styleName;("shape"==curTool||"text"==curTool||"image"==curTool)&&(a=curTool),$("#edOpacity").val()/100!=toolProp.opacity[a]&&(toolProp.opacity[a]=$("#edOpacity").val()/100,project.drawCatch())}}function radiusChange(){setValue||void 0==tool||$("#edRadius").val()!=toolProp.radius[curTool]&&(toolProp.radius[curTool]=$("#edRadius").val(),project.drawCatch())}function sideChange(){setValue||void 0==tool||$("#edSide").val()!=toolProp.side[curTool]&&(toolProp.side[curTool]=$("#edSide").val(),project.drawCatch())}function innerDiameterChange(){setValue||void 0==tool||$("#edInnerDiameter").val()!=toolProp.innerDiameter[setting.shape.type]&&(toolProp.innerDiameter[setting.shape.type]=$("#edInnerDiameter").val(),project.drawCatch())}function fillChange(){setValue||void 0==tool||(toolProp.fill[curTool]=$("#ckFill")[0].checked,project.drawCatch())}function globalChange(){setValue||void 0==tool||(toolProp.global[tool.styleName]=$("#ckGlobalPath")[0].checked)}function randomColor(){setValue||void 0==tool||(toolProp.colors[tool.styleName]=$("#ckRandomColor")[0].checked)}function adjustPaint(){var a=$("#content_paint"),b=$("#content_paint canvas"),c=a.width(),d=a.height();showAds&&(c-=182),b.css("left",Math.max((c-b.width())/2,0)+"px"),b.css("top",Math.max((d-b.height())/2,0)+"px")}function brushLoaded(){toolProp.size.brush=originBrush.width,"brush"==tool.styleName&&$("#edSize").val(toolProp.size[tool.styleName]),canvasBrushCatch.width=canvasBrush.width=originBrush.width,canvasBrushCatch.height=canvasBrush.height=originBrush.height,createPatternBrush()}function createPatternBrush(){var a;if(a="color"==fillEdit?currentFill.fill:currentFill.fill1,"pattern"==a.type&&null!=a.pattern.url&&null==a.pattern.image)return a.pattern.image=new Image,a.pattern.image.onload=function(){createPatternBrush(),project.drawCatch()},void(a.pattern.image.src="https://www.youidraw.com/apps/painter/assets/texture/"+a.pattern.url);var b=canvasBrush.getContext("2d");b.clearRect(0,0,canvasBrush.width,canvasBrush.height),b.drawImage(originBrush,0,0,canvasBrush.width,canvasBrush.height);var c=b.getImageData(0,0,canvasBrush.width,canvasBrush.height);if(void 0!=c){var d=null;if("color"!=currentFill.fill.type){var e=canvasBrushCatch.getContext("2d");e.fillStyle=createStyle(e,currentFill.fill,0,0,canvasBrush.width,canvasBrush.height),e.fillRect(0,0,canvasBrush.width,canvasBrush.height),d=e.getImageData(0,0,canvasBrush.width,canvasBrush.height)}for(var f=c.data,g=0;g<c.height;g++)for(var h=0;h<c.width;h++){var i=4*(g*c.width+h);"color"==currentFill.fill.type?(f[i]=currentFill.fill.r,f[i+1]=currentFill.fill.g,f[i+2]=currentFill.fill.b):(f[i]=d.data[i],f[i+1]=d.data[i+1],f[i+2]=d.data[i+2])}var b=canvasBrush.getContext("2d");b.putImageData(c,0,0),currentBrush.src=canvasBrush.toDataURL("image/png")}}function dblclick(){0!=project.catchText&&(project.openEdit(),project.drawCatch())}function handleMouseDown(a){if(bMouseDown=!1,0==a.button&&!($("#menuContext:visible").length>0))if(addText=!1,$("#fillDialog:visible").length>0&&("pattern"!=currentFill.fill.type&&createPatternBrush(),$("#popupColor").hide(),$("#fillDialog").hide()),client2Local(a,curPoint),bMouseDown=!0,"image"==curTool||"shape"==curTool||"text"==curTool||"select"==curTool){var b=project.startMove(curPoint.x,curPoint.y);0==b&&("image"==curTool&&null!=curOpenImage?project.addImage(curOpenImage,curPoint.x,curPoint.y):"shape"==curTool?project.addShape(curPoint.x,curPoint.y):"text"==curTool?$("#edText").is(":visible")&&""!=project.catchTextContent?(project.closeEdit(),project.drawCatch(!1)):addText=!0:"select"==curTool&&project.addSelect(curPoint.x,curPoint.y))}else if("bucket"==curTool){var c=project.getDragType(curPoint.x,curPoint.y);project.addBucket(c)}else project.drawCatch(!0),tool.paintTemplate(curPoint.x,curPoint.y,"strokeStart"),"eraser"==curTool&&tool.paintTemplate(curPoint.x,curPoint.y,"stroke")}function handleMouseMove(a){var b={x:0,y:0};if(client2Local(a,b),!bMouseDown){var c=0;return("image"==curTool||"shape"==curTool||"text"==curTool||"select"==curTool)&&(c=project.getDragType(b.x,b.y)),void(0==c?"bucket"==curTool?$(project.catchCanvas).css("cursor","pointer"):"select"==curTool?$(project.catchCanvas).css("cursor","crosshair"):"eraser"==curTool?($(project.catchCanvas).css("cursor","none"),project.drawEraserOutline(b.x,b.y)):$(project.catchCanvas).css("cursor","default"):1==c?$(project.catchCanvas).css("cursor","move"):2==c?$(project.catchCanvas).css("cursor","nw-resize"):3==c?$(project.catchCanvas).css("cursor","n-resize"):4==c?$(project.catchCanvas).css("cursor","ne-resize"):5==c?$(project.catchCanvas).css("cursor","e-resize"):6==c?$(project.catchCanvas).css("cursor","se-resize"):7==c?$(project.catchCanvas).css("cursor","s-resize"):8==c?$(project.catchCanvas).css("cursor","sw-resize"):9==c?$(project.catchCanvas).css("cursor","w-resize"):10==c&&$(project.catchCanvas).css("cursor","crosshair"))}return"image"==curTool||"shape"==curTool||"text"==curTool||"select"==curTool?void(0==$("#edText").is(":visible")&&project.moving(b.x-curPoint.x,b.y-curPoint.y,a)):("bucket"!=curTool&&(tool.paintTemplate(b.x,b.y,"stroke"),"eraser"==curTool&&($(project.catchCanvas).css("cursor","none"),project.drawEraserOutline(b.x,b.y))),curPoint.x=b.x,void(curPoint.y=b.y))}function handleMouseUp(a){var b=null;"image"==curTool||"shape"==curTool||"text"==curTool||"select"==curTool?(addText&&(client2Local(a,curPoint),project.addText(curPoint.x,curPoint.y),addText=!1),project.endMove()):(tool.paintTemplate(0,0,"strokeEnd"),b=tool.getPath()),bMouseDown=!1,project.saveStack(null,b)}function handleTouchStart(a){if(1==a.touches.length){var b={};return b.clientX=a.touches[0].pageX,b.clientY=a.touches[0].pageY,b.button=0,handleMouseDown(b),!1}}function handleTouchMove(a){if(1==a.touches.length){var b={};return b.clientX=a.touches[0].pageX,b.clientY=a.touches[0].pageY,handleMouseMove(b),!1}}function handleTouchEnd(a){if(1==a.changedTouches.length){var b={};return b.clientX=a.changedTouches[0].pageX,b.clientY=a.changedTouches[0].pageY,handleMouseUp(b),!1}}function changeFill(){var a,b=!1,c="#FFF";if(a="color"==fillEdit?currentFill.fill:currentFill.fill1,"color"==a.type)c=a.color;else if("gradient"==a.type){c="linear"==a.gradient.type?"linear-gradient("+a.gradient.angle+"deg":"radial-gradient("+parseInt(100*a.gradient.startX)+"% "+parseInt(100*a.gradient.startY)+"%,circle farthest-corner";var d=a.gradient.colorStops;for(var e in d)c+=",rgba("+d[e].r+","+d[e].g+","+d[e].b+","+d[e].a+") "+parseInt(100*d[e].p)+"%";c+=")",c=css3head+c}else"pattern"==a.type&&null!=a.pattern.url&&(c="url(https://www.youidraw.com/apps/painter/assets/texture/"+a.pattern.url+")",b=!0);$("#"+fillEdit).css("background",c),"pattern"==a.type&&$("#"+fillEdit).css("background-size","100% 100%"),b?createPattern():project.drawCatch()}function saveToServer(a){fileUpload(a,document.getElementById("painter").toDataURL("image/png"),"image.png"),alert("/uploadfile?type="+a+"&userid="+curUserID)}function fileUpload(a,b,c){var d="youiadaurora",e=new XMLHttpRequest,f="--"+d+'\r\nContent-Disposition: form-data; name="file"; filename="'+c+'"\r\nContent-type: application/json\r\n\r\n'+b+"\r\n--"+d+"--\r\n\r\n";e.open("POST","/uploadfile?type="+a+"&userid="+curUserID,!0),e.setRequestHeader("Content-type","multipart/form-data; boundary="+d),e.onreadystatechange=function(){4==e.readyState&&200!=e.status&&alert("Uploaded failed!")},e.send(f)}function fileSelectChange(a){var b=a.target.files[0];curOpenImage=new Image,curOpenImage.onload=function(){0==addImage?(project.painter.width=curOpenImage.width,project.painter.height=curOpenImage.height,project.painter.transparent=!0,project.changeBackground(),project.saveStack(curOpenImage),project.initCanvas(!1),adjustPaint()):(setCurTool("image"),project.addImage(curOpenImage),$("#content_paint").focus())};var c=new FileReader;c.onloadend=function(){curOpenImage.src=this.result},c.readAsDataURL(b),a.target.value=""}function toolClick(a){if("color"==a||"color1"==a){fillEdit=a,initGradient("color"==a?currentFill.fill:currentFill.fill1);var b=$("#"+a).offset(),c=$("#fillDialog").height();return b.top+c>$(window).height()&&(b.top=b.top+44-c),void $("#fillDialog").css("left",b.left+48+"px").css("top",b.top+"px").show()}return"image"==a?(addImage=!0,void $("#fileSelect").trigger("click")):void setCurTool(a)}function setCurTool(a){project.mergeCatch(!0),curTool=a;var b=["select","pencil","brush","bucket","eraser","shape","image","text"];for(i in b)a==b[i]?$("#"+b[i]).addClass("tool_icon_selected"):$("#"+b[i]).removeClass("tool_icon_selected");changeTool()}function adjustPropertiesLayout(){var a=tool.styleName;setValue=!0,"eraser"==curTool?$("#edSize").spinner("option","min",1).spinner("option","max",50).spinner("option","step",1):"brush"==curTool?$("#edSize").spinner("option","min",1).spinner("option","max",100).spinner("option","step",1):"text"==curTool?$("#edSize").spinner("option","min",5).spinner("option","max",300).spinner("option","step",1):$("#edSize").spinner("option","min",.5).spinner("option","max",10).spinner("option","step",.5),"shape"==curTool||"text"==curTool||"image"==curTool?(a=curTool,$("#edBorderSize").val(toolProp.size[curTool]),"text"==curTool&&$("#edSize").val(toolProp.font.size)):$("#edSize").val(toolProp.size[tool.styleName]),$("#edSpace").val(toolProp.space[tool.styleName]),$("#edLength").val(100*toolProp.length[tool.styleName]),$("#edOpacity").val(100*toolProp.opacity[a]);var b=$("#ckGlobalPath");b.length>0&&(b[0].checked=toolProp.global[tool.styleName]),b=$("#ckRandomColor"),b.length>0&&(b[0].checked=toolProp.colors[tool.styleName]),$("#edRadius").val(toolProp.radius[curTool]),$("#edSide").val(toolProp.side[curTool]),$("#edInnerDiameter").val(toolProp.innerDiameter[setting.shape.type]),b=$("#ckFill"),b.length>0&&(b[0].checked=toolProp.fill[curTool]),setValue=!1,"pencil"==curTool?$("#liPencil").show():$("#liPencil").hide(),"brush"==curTool?$("#liBrush").show():$("#liBrush").hide(),"brush"==curTool?$("#liSpace").show():$("#liSpace").hide(),"pencil"==curTool&&"fur"==tool.styleName?$("#liLength").show():$("#liLength").hide(),"shape"==curTool?$("#liShape").show():$("#liShape").hide(),"shape"==curTool?$("#liFill").show():$("#liFill").hide(),"shape"==curTool&&"roundrect"==setting.shape.type?$("#liRadius").show():$("#liRadius").hide(),"shape"!=curTool||"convex"!=setting.shape.type&&"concave"!=setting.shape.type&&"gear"!=setting.shape.type?$("#liSide").hide():$("#liSide").show(),"shape"!=curTool||"concave"!=setting.shape.type&&"gear"!=setting.shape.type?$("#liInnerDiameter").hide():$("#liInnerDiameter").show(),"shape"!=curTool&&"image"!=curTool&&"select"!=curTool?$("#liSize").show():$("#liSize").hide(),"text"==curTool?$("#liFont").show():$("#liFont").hide(),"shape"==curTool||"text"==curTool?$("#liBorderSize").show():$("#liBorderSize").hide(),"eraser"==curTool||"select"==curTool?$("#liOpacity").hide():$("#liOpacity").show(),"pencil"==curTool&&"plain"!=tool.styleName&&"ribbon"!=tool.styleName&&"trail"!=tool.styleName?$("#liGlobalPath").show():$("#liGlobalPath").hide(),"pencil"==curTool?$("#liRandomColor").show():$("#liRandomColor").hide(),"select"==curTool?$("#liNoOption").show():$("#liNoOption").hide()}function changeTool(){"pencil"==curTool?tool.setStyle($("#cmbPencil").val().toLowerCase()):("brush"==curTool||"eraser"==curTool)&&tool.setStyle(curTool),adjustPropertiesLayout()}function urlLoaded(){project.painter.width=this.width,project.painter.height=this.height,project.initCanvas(!0),project.context.clearRect(0,0,project.context.canvas.width,project.context.canvas.height),project.context.drawImage(this,0,0,this.width,this.height),project.saveStack(),adjustPaint()}function createStyle(a,b,c,d,e,f){if("gradient"==b.type){var g;g="linear"==b.gradient.type?b.gradient.angle>=0&&b.gradient.angle<45?a.createLinearGradient(c,d+f,c+e,d+(1-b.gradient.angle/45)*f):b.gradient.angle>=45&&b.gradient.angle<90?a.createLinearGradient(c,d+f,c+(1-(b.gradient.angle-45)/45)*e,d):b.gradient.angle>=90&&b.gradient.angle<135?a.createLinearGradient(c+e,d+f,c+(1-(b.gradient.angle-90)/45)*e,d):b.gradient.angle>=135&&b.gradient.angle<180?a.createLinearGradient(c+e,d+f,c,d+(b.gradient.angle-135)/45*f):b.gradient.angle>=180&&b.gradient.angle<225?a.createLinearGradient(c+e,d,c,d+(b.gradient.angle-180)/45*f):b.gradient.angle>=225&&b.gradient.angle<270?a.createLinearGradient(c+e,d,c+(b.gradient.angle-225)/45*e,d+f):b.gradient.angle>=270&&b.gradient.angle<315?a.createLinearGradient(c,d,c+(b.gradient.angle-270)/45*e,d+f):b.gradient.angle>=315&&b.gradient.angle<360?a.createLinearGradient(c,d,c+e,d+(1-(b.gradient.angle-315)/45)*f):a.createLinearGradient(c,d,c+e,d):a.createRadialGradient(c+b.gradient.startX*e,d+b.gradient.startY*f,0,c+b.gradient.endX*e,d+b.gradient.endY*f,Math.max(e,f)/2);var h=b.gradient.colorStops;for(var i in h){var j=h[i].r+","+h[i].g+","+h[i].b;g.addColorStop(h[i].p,"rgba("+j+","+h[i].a+")")}return g}return"pattern"==b.type&&null!=b.pattern.image?a.createPattern(b.pattern.image,"repeat"):b.color}function paintManager(a){this.init(a)}function plain(a){this.init(a)}function eraser(a){this.init(a)}function sketchy(a){this.init(a)}function shaded(a){this.init(a)}function web(a){this.init(a)}function trail(a){this.init(a)}function bargs(a){var b,c=[];for(b=1;b<arguments.length;b++)c.push(arguments[b]);return function(){return a.apply(this,c)}}function ribbon(a){this.init(a)}function fur(a){this.init(a)}function brush(a){this.init(a)}function youiad_painter(a,b){this.init(a,b)}var driveClient=null,premium=null,project,tool,curUserID="",fillEdit="",currentFill={fill:{type:"color",color:"#888888",gradient:{colorStops:[{p:0,r:200,g:200,b:200,a:1,s:1},{p:1,r:100,g:100,b:100,a:1,s:0}],type:"linear",angle:0,startX:.5,startY:.5,endX:.5,endY:.5},pattern:{url:null,image:null}},fill1:{type:"color",color:"#FF8888",gradient:{colorStops:[{p:0,r:200,g:200,b:200,a:1,s:1},{p:1,r:100,g:100,b:100,a:1,s:0}],type:"linear",angle:0,startX:.5,startY:.5,endX:.5,endY:.5},pattern:{url:null,image:null}}},canvasBrush,canvasBrushCatch,originBrush,currentBrush,curTool="pencil",toolProp={size:{plain:1,sketchy:1,shaded:1,web:1,trail:1,ribbon:1,fur:1,eraser:15,shape:1,text:0},opacity:{plain:1,sketchy:1,shaded:1,web:1,trail:1,ribbon:1,fur:1,brush:1,shape:1,image:1,text:1},colors:{plain:!1,sketchy:!1,shaded:!1,web:!1,trail:!1,ribbon:!0,fur:!0},global:{sketchy:!0,shaded:!0,web:!0,fur:!0},space:{brush:.5},length:{fur:.5},fill:{shape:!0,text:!0},radius:{shape:20},side:{shape:5},innerDiameter:{concave:.38,gear:.8},font:{size:18,family:"Arial"}},bMouseDown=!1,curPoint={x:0,y:0},setValue=!1,addImage=!1,curOpenImage=null,addText=!1,setting={brush:{loaded:!1,index:0},shape:{loaded:!1,index:0,type:"rect"}},fileName,userID,agent=navigator.userAgent,css3head="-webkit-";agent.indexOf("MSIE")>=0?css3head="-ms-":agent.indexOf("Opera")>=0?css3head="-o-":agent.indexOf("WebKit")>=0?css3head="-webkit-":agent.indexOf("Gecko")>=0&&(css3head="-moz-");var mac=-1!=navigator.userAgent.indexOf("Mac",0)?1:0,adsInited=!1,showAds=!1;$(document).ready(function(){QueryString.Initial(),userID=QueryString.GetValue("userid"),fileName=QueryString.GetValue("file");var a="border: 1px solid #888; padding: 0px;";$("#layout_paint").w2layout({name:"layout_paint",panels:[{type:"top",size:41,style:a+"border-radius: 6px 6px 0px 0px;",content:'<div id="layoutHeader" style="width:100%;height:100%;"></div>'},{type:"left",size:40,style:a+"border-radius: 6px 6px 0px 0px;",content:'<div id="layoutToolbox" style="width:100%;height:100%"></div>'},{type:"main",style:a,content:'<div id="layoutMain" style="width:100%;height:100%"></div>'}]}),$("#header_paint").appendTo("#layoutHeader").css("overflow","hidden"),$("#toolbox_paint").appendTo("#layoutToolbox"),$("#content_paint").appendTo("#layoutMain"),project=new youiad_painter(document.getElementById("painter"),document.getElementById("catch"));var b=$("#content_paint")[0];b.onmousedown=handleMouseDown,b.onmouseup=handleMouseUp,b.onmousemove=handleMouseMove,b.ontouchstart=handleTouchStart,b.ontouchend=handleTouchEnd,b.ontouchmove=handleTouchMove,setValue=!0,$("#edSize").spinner({change:sizeChange,stop:sizeChange}).spinner("option","min",.5).spinner("option","max",10).spinner("option","step",.5),$("#edBorderSize").spinner({change:borderSizeChange,stop:borderSizeChange}).spinner("option","min",0).spinner("option","max",100).spinner("option","step",1),$("#edSpace").spinner({change:spaceChange,stop:spaceChange}).spinner("option","min",.5).spinner("option","max",100).spinner("option","step",1),$("#edLength").spinner({change:lengthChange,stop:lengthChange}).spinner("option","min",1).spinner("option","max",100).spinner("option","step",1),$("#edOpacity").spinner({change:opacityChange,stop:opacityChange}).spinner("option","min",0).spinner("option","max",100).spinner("option","step",1),$("#edRadius").spinner({change:radiusChange,stop:radiusChange}).spinner("option","min",0).spinner("option","max",200).spinner("option","step",1),$("#edSide").spinner({change:sideChange,stop:sideChange}).spinner("option","min",3).spinner("option","max",200).spinner("option","step",1),$("#edInnerDiameter").spinner({change:innerDiameterChange,stop:innerDiameterChange}).spinner("option","min",0).spinner("option","max",1).spinner("option","step",.1),setValue=!1,tool=new paintManager(project.context),$("#ckFill").click(function(){fillChange()}),$("#ckGlobalPath").click(function(){globalChange()}),$("#ckRandomColor").click(function(){randomColor()}),document.getElementById("fileSelect").addEventListener("change",fileSelectChange,!1),$("#cmbPencil").change(function(){pencilChange()}),initFonts(),$("#cmbfont").change(function(){fontChange()}),$("#select, #pencil, #brush, #bucket, #eraser, #color, #color1, #shape, #image, #text").click(function(){var a=$(this).attr("id");return toolClick(a),"color"==a||"color1"==a?!1:!0}),$(document.body).append('<ul id="menuContext" style="display: none; position: absolute;z-index: 1000;"/>		<ul id="menuMain" style="display: none; position: absolute;z-index: 1000;"/>'),$("#menuContext").html(getMenuHtml(["Copy","Cut","Paste","Delete","Crop","Select All"])),$("#menuMain").html(getMenuHtml(['<span class="ui-icon new-file"/>New Image','<span class="ui-icon open-file"/>Open Image','<span class="ui-icon clear-file"></span>Clear',"",'<span class="ui-icon project-setting"></span>Image Size',"",'<span class="ui-icon export-file"/>Export','<span class="ui-icon print-file"/>Print',"",'<span class="ui-icon undo-icon"></span>Undo','<span class="ui-icon redo-icon"></span>Redo',"",'<span class="ui-icon ui-icon-help"/>User Guide','<span class="ui-icon ui-icon-home"/>Home Page','<span class="ui-icon ui-icon-mail-closed"/>Feedback'])),$("#menuContext,#menuMain").addClass("notranslate").menu().hide().css("position","absolute"),$("ul#menuMain > li").click(function(){menuSelect($(this).text())}),$("ul#menuContext > li").click(function(){menuContextSelect($(this).text())}),canvasBrush=document.createElement("canvas"),canvasBrushCatch=document.createElement("canvas"),currentBrush=new Image,originBrush=new Image,originBrush.onload=brushLoaded,$("#fillDialog").load("https://cors-proxy.htmldriven.com/?url=https://www.youidraw.com/apps/painter/fill.html"),$("#btnMenu").css({background:"none",border:"none"}).button({icons:{primary:"icon_painter36"}}),$("#imgBrush, #btnBrush").click(function(){if(0==setting.brush.loaded){for(var a=1;44>a;a++)$("#moreBrush").append("<li><div style='width:100%;height:100%;background:url(https://www.youidraw.com/apps/painter/assets/brush/brush"+padLeft(a,2,"0")+".png);background-size:100% 100%;'/></li>");$("ul#moreBrush > li").click(function(){brushChange($(this).index())}),brushChange(),setting.brush.loaded=!0}var b=$("#imgBrush").offset();return $("#moreBrush").css("left",b.left+"px"),$("#moreBrush").css("top",b.top+18+"px"),$("#moreBrush").show(),!1}),$("#imgShape, #btnShape").click(function(){if(0==setting.shape.loaded){var a=["rect","rrect","ellipse","convex","concave","gear"];for(var b in a)$("#moreShape").append("<li><div class='icons24 icon_"+a[b]+"24'/></li>");$("ul#moreShape > li").click(function(){shapeChange($(this).index())}),shapeChange(),setting.shape.loaded=!0}var c=$("#imgShape").offset();return $("#moreShape").css("left",c.left+"px"),$("#moreShape").css("top",c.top+28+"px"),$("#moreShape").show(),!1}),$("#btnMenu").click(function(){var a=$(this).offset();return $("#menuMain").css("left",a.left+"px"),$("#menuMain").css("top",a.top+28+"px"),$("#menuMain").show(),!1}),$(document).click(function(a){var b=$(a.target);0==b.closest("#menuMain").length&&$("#menuMain").hide(),0==b.closest("#menuContext").length&&$("#menuContext").hide(),0==b.closest("#moreBrush").length&&$("#moreBrush").hide(),0==b.closest("#moreShape").length&&$("#moreShape").hide(),$("#fillDialog:visible").length>0&&0==b.closest("#fillDialog").length&&("pattern"!=currentFill.fill.type&&createPatternBrush(),$("#fillDialog").hide(),$("#popupColor").hide()),$("#popupColor:visible").length>0&&0==b.closest("#popupColor").length&&$("#popupColor").hide()}),$("#content_paint").dblclick(function(a){dblclick(a)}),$("#content_paint").keydown(function(a){return 1==project.catchText&&0==$("#edText").is(":visible")&&27!=a.keyCode?(dblclick(a),!1):!0}),$(document.body).contextmenu(function(a){if(void 0==a.target||"edText"!=a.target.id){if(void 0!=a.target&&"catch"==a.target.id){$("#menuContext").css("left",a.clientX+$(document).scrollLeft()+"px"),$("#menuContext").css("top",a.clientY+$(document).scrollTop()+"px");var b=$("#menuContext > li"),c=project.catchSelect&&project.catchSize.w>0&&project.catchSize.h>0;c?$(b[0]).show():$(b[0]).hide(),c?$(b[1]).show():$(b[1]).hide(),project.catchImageCopy?$(b[2]).show():$(b[2]).hide(),c||project.catchImage||project.catchShape||project.catchText?$(b[3]).show():$(b[3]).hide(),c?$(b[4]).show():$(b[4]).hide(),$("#menuContext").show()}return!1}return!0}),$("#edText")[0].addEventListener("input",function(){project.catchTextContent=this.value,project.drawCatch()},!1),$("#edText").keydown(function(a){27==a.keyCode&&1==$("#edText").is(":visible")&&(project.closeEdit(),project.drawCatch(!1))}),project.context.lineCap="round",project.context.lineJoin="round",project.catchContext.lineCap="round",project.catchContext.lineJoin="round",toolClick("pencil"),fillEdit="color";var c=cutHex(currentFill.fill.color);currentFill.fill.r=hexToR(c),currentFill.fill.g=hexToG(c),currentFill.fill.b=hexToB(c),changeFill(),fillEdit="color1",changeFill(),brushChange(0),shapeChange(0),setTimeout("$(window).resize()",300),setTimeout("adjustPaint()",500),fileName&&openProject(userID,fileName,"yip",openSuccessful,openFailed);for(var d=["btnLogoCreator","btnDrawing","btnUser"],e=["icon_logocreator28","icon_drawing28","icon_btnuser"],f=0;f<d.length;f++)$("#"+d[f]).css({background:"none",border:"none"}).button({icons:{primary:e[f]},text:!0}).find(".ui-button-text").addClass("btn-toolbar");$("#btnUser").click(function(){if(driveClient.isSignIn("app")){var a=$("#menuUser"),b=a.children();driveClient.isPremium()?$(b[2]).hide():$(b[2]).show(),a.show().position({my:"left top",at:"left bottom",of:this}),$(document).one("click",function(){a.hide()})}else signCmd("Sign In");return!1}),$("#btnLogoCreator, #btnDrawing").click(function(){var a="../"+("btnLogoCreator"==this.id?"logocreator":"drawing");window.open(a,"_blank","",!0)}),$("ul#menuUser li").click(function(){signCmd($(this).text())}),driveClient=new youidrawDrive(!0),driveClient.setloginCallback(updateLoginInfo),driveClient.settings={ads:void 0,signIn:void 0},waitingScreen("sign in"),driveClient.autoLogin(!0,function(){waitingScreen("none"),void 0==driveClient.settings.signIn&&(console.log("auto 1"),driveClient.settings.signIn=!1,updateAds())
}),$.ajax({url:"https://cors-proxy.htmldriven.com/?url=https://www.youidraw.com/getSysSettings",dataType:"text",data:{key:"ads"},timeout:6e4,error:function(){alert("Error loading Data")},success:function(a){if("failed"!=a){var b;try{b=JSON.parse(a)}catch(c){}b&&(driveClient.settings.ads=1==b.value||"true"==b.value,updateAds())}}})}),$(window).resize(function(){var a=$(window).height();$("#layout_paint").height(a),adjustPaint()}),document.onkeypress=banBackSpace,document.onkeydown=banBackSpace,window.onbeforeunload=function(){return setTimeout(function(){_t=setTimeout(onunloadcancel,0)},0),"Save your paint before leave."},window.onunloadcancel=function(){clearTimeout(_t)},window.onunload=function(){opener&&(opener.painterapp=null)},paintManager.prototype={context:null,style:null,styleName:"",init:function(a){this.context=a},destroy:function(){},setStyle:function(styleClass){this.styleName!=styleClass&&(this.style=eval("new "+styleClass+"(this.context)"),this.styleName=styleClass)},paintTemplate:function(a,b,c){void 0!=this.style[c]&&this.style[c](a,b)},getPath:function(){return("sketchy"==this.styleName||"shaded"==this.styleName||"web"==this.styleName||"fur"==this.styleName)&&toolProp.global[this.styleName]?{styleName:this.styleName,points:JSON.stringify(this.style.points),count:this.style.count}:!1},setPath:function(a){a.styleName==this.styleName&&toolProp.global[this.styleName]&&(this.style.points=JSON.parse(a.points),this.style.count=a.count)}},plain.prototype={context:null,prevMouseX:null,prevMouseY:null,strokeStyle:null,init:function(a){this.context=a,this.context.globalCompositeOperation="source-over"},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.lineWidth=toolProp.size.plain,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.globalAlpha=toolProp.opacity.plain,this.context.strokeStyle=this.strokeStyle},stroke:function(a,b){toolProp.colors.plain&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+")"),this.context.beginPath(),this.context.moveTo(this.prevMouseX,this.prevMouseY),this.context.lineTo(a,b),this.context.stroke(),this.prevMouseX=a,this.prevMouseY=b},strokeEnd:function(){this.context.globalAlpha=1}},eraser.prototype={context:null,prevMouseX:null,prevMouseY:null,init:function(a){this.context=a},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b},stroke:function(a,b){for(var c,d,e=toolProp.size.eraser,f={x:this.prevMouseX,y:this.prevMouseY},g={x:a,y:b},h=parseInt(distanceBetween2Points(f,g)),i=getLineAngle(f,g),j=0;h>=j||0==j;j+=.5)c=f.x+Math.cos(i)*j-e/2,d=f.y+Math.sin(i)*j-e/2,this.context.clearRect(parseInt(c),parseInt(d),e,e);this.prevMouseX=a,this.prevMouseY=b},strokeEnd:function(){}},sketchy.prototype={context:null,prevMouseX:null,prevMouseY:null,points:null,count:null,strokeStyle:null,init:function(a){this.context=a,this.context.globalCompositeOperation="source-over",this.points=new Array,this.count=0},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.lineWidth=toolProp.size.sketchy,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle,0==toolProp.global.sketchy&&this.clearPath()},clearPath:function(){this.points.length=0,this.count=0},stroke:function(a,b){var c,d,e,f;for(this.points.push([a,b]),toolProp.colors.sketchy&&(this.context.strokeStyle=this.strokeStyle),this.context.globalAlpha=.5*toolProp.opacity.sketchy,this.context.beginPath(),this.context.moveTo(this.prevMouseX,this.prevMouseY),this.context.lineTo(a,b),this.context.stroke(),c=0;c<this.points.length;c++)d=this.points[c][0]-this.points[this.count][0],e=this.points[c][1]-this.points[this.count][1],f=d*d+e*e,4e3>f&&Math.random()>f/2e3&&(this.context.beginPath(),this.context.globalAlpha=.15*toolProp.opacity.sketchy,toolProp.colors.sketchy&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+" )"),this.context.moveTo(this.points[this.count][0]+.3*d,this.points[this.count][1]+.3*e),this.context.lineTo(this.points[c][0]-.3*d,this.points[c][1]-.3*e),this.context.stroke());this.prevMouseX=a,this.prevMouseY=b,this.count++},strokeEnd:function(){this.context.globalAlpha=1}},shaded.prototype={context:null,prevMouseX:null,prevMouseY:null,points:null,count:null,strokeStyle:null,init:function(a){this.context=a,this.context.lineWidth=toolProp.size.shaded,this.context.globalCompositeOperation="source-over",this.points=new Array,this.count=0},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.lineWidth=toolProp.size.shaded,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle,0==toolProp.global.shaded&&this.clearPath()},clearPath:function(){this.points.length=0,this.count=0},stroke:function(a,b){var c,d,e,f;for(this.points.push([a,b]),c=0;c<this.points.length;c++)d=this.points[c][0]-this.points[this.count][0],e=this.points[c][1]-this.points[this.count][1],f=d*d+e*e,1e3>f&&(this.context.globalAlpha=.2*(1-f/1e3)*toolProp.opacity.shaded,toolProp.colors.shaded&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+" )"),this.context.beginPath(),this.context.moveTo(this.points[this.count][0],this.points[this.count][1]),this.context.lineTo(this.points[c][0],this.points[c][1]),this.context.stroke());this.prevMouseX=a,this.prevMouseY=b,this.count++},strokeEnd:function(){this.context.globalAlpha=1}},web.prototype={context:null,prevMouseX:null,prevMouseY:null,points:null,count:null,strokeStyle:null,init:function(a){this.context=a,this.context.globalCompositeOperation="source-over",this.points=new Array,this.count=0},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.lineWidth=toolProp.size.web,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle,0==toolProp.global.web&&this.clearPath()},clearPath:function(){this.points.length=0,this.count=0},stroke:function(a,b){var c,d,e,f;for(this.points.push([a,b]),toolProp.colors.web&&(this.context.strokeStyle=this.strokeStyle),this.context.globalAlpha=.5*toolProp.opacity.web,this.context.beginPath(),this.context.moveTo(this.prevMouseX,this.prevMouseY),this.context.lineTo(a,b),this.context.stroke(),this.context.globalAlpha=.1*toolProp.opacity.web,c=0;c<this.points.length;c++)d=this.points[c][0]-this.points[this.count][0],e=this.points[c][1]-this.points[this.count][1],f=d*d+e*e,2500>f&&Math.random()>.9&&(toolProp.colors.web&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+" )"),this.context.beginPath(),this.context.moveTo(this.points[this.count][0],this.points[this.count][1]),this.context.lineTo(this.points[c][0],this.points[c][1]),this.context.stroke());this.prevMouseX=a,this.prevMouseY=b,this.count++},strokeEnd:function(){this.context.globalAlpha=1}},trail.prototype={context:null,prevMouseX:null,prevMouseY:null,points:null,count:null,strokeStyle:null,init:function(a){this.context=a,this.context.lineWidth=1,this.points=new Array,this.count=0},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.points=new Array,this.context.lineWidth=toolProp.size.trail,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle},stroke:function(a,b){var c,d,e=15,f=a,g=b;if(this.count){for(this.points.push([f,g]),toolProp.colors.trail&&(this.context.strokeStyle=this.strokeStyle),this.context.globalAlpha=.5*toolProp.opacity.trail,this.context.beginPath(),this.context.moveTo(this.prevMouseX,this.prevMouseY),this.context.lineTo(f,g),this.context.stroke(),c=this.points.slice(this.points.length-e,this.points.length),d=0;d<c.length;d++)this.context.globalAlpha=.15*toolProp.opacity.trail,toolProp.colors.trail&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+" )"),this.context.beginPath(),this.context.moveTo(f,g),this.context.lineTo(c[d][0],c[d][1]),this.context.stroke();this.prevMouseX=f,this.prevMouseY=g}this.count++},strokeEnd:function(){this.context.globalAlpha=1}},ribbon.prototype={context:null,mouseX:null,mouseY:null,painters:null,colors:null,interval:null,strokeStyle:null,init:function(a){this.context=a,this.context.lineWidth=1,this.context.globalCompositeOperation="source-over",this.mouseX=this.context.canvas.width/2,this.mouseY=this.context.canvas.height/2,this.painters=new Array,this.colors=new Array;for(var b=0;50>b;b++)this.painters.push({dx:this.context.canvas.width/2,dy:this.context.canvas.height/2,ax:0,ay:0,div:.1,ease:.2*Math.random()+.6});this.isDrawing=!1},destroy:function(){this.interval&&(clearInterval(this.interval),this.interval=null)},strokeStart:function(a,b){this.interval||(this.interval=setInterval(bargs(function(a){return a.update(),!1},this),1e3/60)),this.mouseX=a,this.mouseY=b,this.context.lineWidth=toolProp.size.ribbon,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle,this.context.globalAlpha=.05*toolProp.opacity.ribbon,this.colors.length=0;for(var c=0;c<this.painters.length;c++)this.painters[c].dx=a,this.painters[c].dy=b,this.colors.push("rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+")");this.shouldDraw=!0},stroke:function(a,b){this.mouseX=a,this.mouseY=b},strokeEnd:function(){var a=this;setTimeout(function(){a.destroy()},200)},update:function(){var a;for(a=0;a<this.painters.length;a++)toolProp.colors.ribbon&&(this.context.strokeStyle=this.colors[a]),this.context.beginPath(),this.context.moveTo(this.painters[a].dx,this.painters[a].dy),this.painters[a].dx-=this.painters[a].ax=(this.painters[a].ax+(this.painters[a].dx-this.mouseX)*this.painters[a].div)*this.painters[a].ease,this.painters[a].dy-=this.painters[a].ay=(this.painters[a].ay+(this.painters[a].dy-this.mouseY)*this.painters[a].div)*this.painters[a].ease,this.context.lineTo(this.painters[a].dx,this.painters[a].dy),this.context.stroke()}},fur.prototype={context:null,prevMouseX:null,prevMouseY:null,points:null,count:null,strokeStyle:null,length:.5,init:function(a){this.context=a,this.context.lineWidth=1,this.points=new Array,this.count=0},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.lineWidth=toolProp.size.fur,this.strokeStyle=createStyle(this.context,currentFill.fill,0,0,this.context.canvas.width,this.context.canvas.height),this.context.strokeStyle=this.strokeStyle,this.context.globalAlpha=.2*toolProp.opacity.fur,this.length=.2+2*toolProp.length.fur,0==toolProp.global.fur&&this.clearPath()},clearPath:function(){this.points.length=0,this.count=0},stroke:function(a,b){var c,d,e,f;for(this.points.push([a,b]),toolProp.colors.fur&&(this.context.strokeStyle=this.strokeStyle),this.context.beginPath(),this.context.moveTo(this.prevMouseX,this.prevMouseY),this.context.lineTo(a,b),this.context.stroke(),c=0;c<this.points.length;c++)d=this.points[c][0]-this.points[this.count][0],e=this.points[c][1]-this.points[this.count][1],f=d*d+e*e,2e3>f&&Math.random()>f/2e3&&(toolProp.colors.fur&&(this.context.strokeStyle="rgb("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+")"),this.context.beginPath(),this.context.moveTo(a+d*this.length,b+e*this.length),this.context.lineTo(a-d*this.length,b-e*this.length),this.context.stroke());this.prevMouseX=a,this.prevMouseY=b,this.count++},strokeEnd:function(){}},brush.prototype={context:null,prevMouseX:null,prevMouseY:null,leaveLength:null,init:function(a){this.context=a,this.context.globalCompositeOperation="source-over"},destroy:function(){},strokeStart:function(a,b){this.prevMouseX=a,this.prevMouseY=b,this.context.globalAlpha=toolProp.opacity.brush;var c=toolProp.size.brush;this.context.drawImage(currentBrush,a-c/2,b-c/2,c,c),this.leaveLength=0},stroke:function(a,b){for(var c,d,e=toolProp.size.brush,f={x:this.prevMouseX,y:this.prevMouseY},g={x:a,y:b},h=parseInt(distanceBetween2Points(f,g)),i=getLineAngle(f,g),j=0,k=Math.max(toolProp.space.brush,.5);this.leaveLength+h>=k;)h-=k-this.leaveLength,j+=k-this.leaveLength,this.leaveLength=0,c=f.x+Math.cos(i)*j-e/2,d=f.y+Math.sin(i)*j-e/2,this.context.drawImage(currentBrush,c,d,e,e);this.leaveLength+=h,this.prevMouseX=a,this.prevMouseY=b},strokeEnd:function(){this.context.globalAlpha=1}},youiad_painter.prototype={painter:{width:1e3,height:600},divCanvas:null,context:null,catchCanvas:null,catchContext:null,canvasImage:null,contextImage:null,stackDatas:null,curStack:0,underApply:!1,catchImage:null,catchImageCopy:null,shapes:new Array("rect","roundrect","ellipse","convex","concave","gear"),catchRotate:0,catchShape:!1,catchText:!1,catchSelect:!1,catchTextContent:"",catchPos:{x:0,y:0},catchSize:{w:0,h:0},catchPts:[],catchSaveRect:{x:0,y:0,w:0,h:0},canMove:0,modify:!1,onSaving:!1,init:function(a,b){if(this.divCanvas=a,this.context=a.getContext("2d"),this.catchCanvas=b,this.catchContext=b.getContext("2d"),this.canvasImage=document.createElement("canvas"),this.contextImage=this.canvasImage.getContext("2d"),this.stackDatas=new Array,void 0!=this.painter.data){var c=new Image;c.src=this.painter.data,this.saveStack(c)}this.initCanvas(!1)},setProject:function(a){if(this.clearUndoStack(),this.painter=a,void 0!=this.painter.data){var b=new Image;b.onload=function(){project.initCanvas(!0),adjustPaint()},b.src=this.painter.data,this.saveStack(b)}},saveImage:function(a){this.painter.transparent||(this.context.globalCompositeOperation="destination-over",this.context.fillStyle="#fff",this.context.beginPath(),this.context.rect(0,0,this.divCanvas.width,this.divCanvas.height),this.context.fill());var b=this.divCanvas.toDataURL("image/"+a),c="data:image/"+a+";base64,";if($.browser.chrome||$.browser.opera){var d=new Blob([decode_base64(b.slice(c.length))],{type:"image/"+a});saveAs(d,"export."+("jpeg"==a?"jpg":a))}else window.open(b,"_blank")},changeBackground:function(){1==this.painter.transparent?$("#painter").addClass("bg_trans"):$("#painter").removeClass("bg_trans")},initCanvas:function(a){var b=this.painter.width,c=this.painter.height;if(0==a&&this.stackDatas.length>0&&this.curStack<this.stackDatas.length){var d=this.stackDatas[this.curStack].image;b=d.width,c=d.height}(this.divCanvas.width!=b||this.divCanvas.height!=c)&&(this.catchCanvas.width=this.divCanvas.width=b,this.catchCanvas.height=this.divCanvas.height=c,adjustPaint()),this.context.clearRect(0,0,this.divCanvas.width,this.divCanvas.height),0==this.stackDatas.length&&(this.curStack=-1,this.saveStack()),this.curStack>this.stackDatas.length-1?this.curStack=this.stackDatas.length-1:this.curStack<0&&(this.curStack=0);var e=this.stackDatas[this.curStack];if(e.image&&""!=e.image.src){var f=this.context.globalAlpha;this.context.globalAlpha=1,this.context.drawImage(e.image,0,0,this.divCanvas.width,this.divCanvas.height),this.context.globalAlpha=f}e.extData&&tool.setPath(e.extData)},openURL:function(a){var b=new Image;b.onload=urlLoaded,b.src=a},saveStack:function(a,b){a||(a=new Image,a.src=this.divCanvas.toDataURL("image/png"));var c={image:a,extData:b?b:null},d=c.extData?JSON.stringify(c.extData):"";if(this.stackDatas.length>0&&this.curStack<this.stackDatas.length){var e=this.stackDatas[this.curStack],f=e.extData?JSON.stringify(e.extData):"";if(a.src==e.image.src&&d==f)return}if(this.stackDatas.length>0){this.curStack>this.stackDatas.length-1?this.curStack=this.stackDatas.length-1:this.curStack<0&&(this.curStack=0);for(var g=this.stackDatas.length-1;g>this.curStack;g--)this.stackDatas.pop()}if(this.stackDatas.push(c),this.curStack=this.stackDatas.length-1,b&&b.points&&this.curStack-1>-1&&!this.stackDatas[this.curStack-1].extData){var h=JSON.parse(JSON.stringify(b));h.points="[]",h.count=0,this.stackDatas[this.curStack-1].extData=h}this.modify=!0},clearUndoStack:function(){this.stackDatas.length=0,this.curStack=-1},undo:function(){this.curStack<1||this.curStack>this.stackDatas.length-1||(this.curStack--,this.initCanvas(!1))},redo:function(){this.curStack<0||this.curStack>=this.stackDatas.length-1||(this.curStack++,this.initCanvas(!1))},cropCatch:function(){if(0!=this.catchSelect){if(null==this.catchImage)return void this.applySelect(0);this.painter.width=this.catchImage.width,this.painter.height=this.catchImage.height,this.saveStack(this.catchImage),this.initCanvas(!1),this.catchImage=null,this.catchSelect=!1,this.drawCatch(!1)}},removeCatch:function(){return this.catchSelect&&null==this.catchImage?(this.applySelect(1),void(this.catchSelect=!1)):(this.catchImage?(this.catchImage=null,change=!0):this.catchShape?(this.catchShape=!1,change=!0):this.catchText&&(this.catchText=!1,change=!0),1==change&&this.drawCatch(),void this.saveStack())},selectAll:function(){this.mergeCatch(),this.catchSelect=!0,this.catchPos.x=0,this.catchPos.y=0,this.catchSize.w=this.divCanvas.width,this.catchSize.h=this.divCanvas.height,this.drawCatch(!1)},pasteClip:function(){null!=this.catchImageCopy&&this.addImage(this.catchImageCopy)},copyCutClip:function(a){if(0!=this.catchSelect){if(null==this.catchImage)return void this.applySelect(2,a);this.catchImageCopy=this.catchImage,a&&(this.catchSelect=!1,this.catchImage=null,this.saveStack()),this.drawCatch(!1)}},mergeCatch:function(a){var b;this.context.translate(this.catchPos.x+this.catchSize.w/2,this.catchPos.y+this.catchSize.h/2),0!=this.catchRotate&&this.context.rotate(this.catchRotate),this.catchImage?(0==this.catchSelect&&(this.context.globalAlpha=toolProp.opacity.image),this.context.drawImage(this.catchImage,-this.catchSize.w/2,-this.catchSize.h/2,this.catchSize.w,this.catchSize.h),0==this.catchSelect&&(this.context.globalAlpha=1),this.catchImage=null,b=!0):this.catchShape?(this.drawShape(this.context),this.catchShape=!1,b=!0):this.catchText&&(this.closeEdit(),this.drawText(this.context),this.catchText=!1,b=!0),0!=this.catchRotate&&this.context.rotate(-this.catchRotate),this.context.translate(-this.catchPos.x-this.catchSize.w/2,-this.catchPos.y-this.catchSize.h/2),this.catchSelect=!1,b&&this.saveStack(),(this.select||b)&&a&&this.drawCatch()},getShape:function(a){return a>-1&&6>a?this.shapes[a]:"rect"},ellipse:function(a,b,c,d,e){var f=.552;a.moveTo(b,-e/2+c),a.bezierCurveTo(d/2*f+b,-e/2+c,d/2+b,-(e/2)*f+c,d/2+b,+c),a.bezierCurveTo(d/2+b,e/2*f+c,d/2*f+b,e/2+c,b,e/2+c),a.bezierCurveTo(-(d/2)*f+b,e/2+c,-d/2+b,e/2*f+c,-d/2+b,c),a.bezierCurveTo(-d/2+b,-(e/2)*f+c,-(d/2)*f+b,-e/2+c,b,-e/2+c)},roundRect:function(a,b,c,d,e,f){"undefined"==typeof f&&(f=0),f=Math.min(f,d/2),f=Math.min(f,e/2),0==f?a.rect(b,c,d,e):(a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c))},convex:function(a,b,c,d,e){a.translate(b+d/2,c+e/2);var f=toolProp.side.shape,g=360/f*(Math.PI/180),h=-90*(Math.PI/180);0==parseInt(f%2)&&(h+=g/2),a.moveTo(Math.cos(h)*d/2,Math.sin(h)*e/2);for(var i=1;f>i;i++)a.lineTo(Math.cos(h+i*g)*d/2,Math.sin(h+i*g)*e/2);a.lineTo(Math.cos(h)*d/2,Math.sin(h)*e/2),a.translate(-b-d/2,-c-e/2)},concave:function(a,b,c,d,e){a.translate(b+d/2,c+e/2);var f=toolProp.side.shape,g=toolProp.innerDiameter[setting.shape.type],h=360/f*(Math.PI/180)/2,i=-90*(Math.PI/180);0==parseInt(f%2)&&(i+=h),a.moveTo(Math.cos(i)*d/2,Math.sin(i)*e/2),a.lineTo(Math.cos(i+h)*g*d/2,Math.sin(i+h)*g*e/2);for(var j=1;f>j;j++)a.lineTo(Math.cos(i+2*j*h)*d/2,Math.sin(i+2*j*h)*e/2),a.lineTo(Math.cos(i+(2*j+1)*h)*g*d/2,Math.sin(i+(2*j+1)*h)*g*e/2);a.lineTo(Math.cos(i)*d/2,Math.sin(i)*e/2),a.translate(-b-d/2,-c-e/2)},gear:function(a,b,c,d,e){a.translate(+b+d/2,+c+e/2);var f=toolProp.side.shape,g=toolProp.innerDiameter[setting.shape.type],h=360/f*(Math.PI/180)/2,i=.25*h,j=-90*(Math.PI/180);0==parseInt(f%2)&&(j+=h),a.moveTo(Math.cos(j+i)*d/2,Math.sin(j+i)*e/2),a.lineTo(Math.cos(j-i)*d/2,Math.sin(j-i)*e/2),a.lineTo(Math.cos(j-h+i)*g*d/2,Math.sin(j-h+i)*g*e/2),a.lineTo(Math.cos(j-h-i)*g*d/2,Math.sin(j-h-i)*g*e/2);for(var k=1;f>k;k++)a.lineTo(Math.cos(j-2*k*h+i)*d/2,Math.sin(j-2*k*h+i)*e/2),a.lineTo(Math.cos(j-2*k*h-i)*d/2,Math.sin(j-2*k*h-i)*e/2),a.lineTo(Math.cos(j-(2*k+1)*h+i)*g*d/2,Math.sin(j-(2*k+1)*h+i)*g*e/2),a.lineTo(Math.cos(j-(2*k+1)*h-i)*g*d/2,Math.sin(j-(2*k+1)*h-i)*g*e/2);a.lineTo(Math.cos(j+i)*d/2,Math.sin(j+i)*e/2),a.translate(-b-d/2,-c-e/2)},addShape:function(a,b){this.context.globalCompositeOperation="source-over",this.mergeCatch(!0),this.catchShape=!0,this.catchPos.x=a,this.catchPos.y=b,this.catchSize.w=0,this.catchSize.h=0,this.catchRotate=0},addImage:function(a,b,c){this.context.globalCompositeOperation="source-over",this.mergeCatch(),this.catchImage=a,this.catchSize.w=a.width,this.catchSize.h=a.height,this.catchRotate=0,void 0==b||void 0==c?(this.catchPos.x=(this.catchCanvas.width-a.width)/2,this.catchPos.y=(this.catchCanvas.height-a.height)/2):(this.catchPos.x=b-a.width/2,this.catchPos.y=c-a.height/2,this.startMove(b,c)),this.drawCatch()},addText:function(a,b){this.context.globalCompositeOperation="source-over",this.mergeCatch(),this.catchTextContent="",this.catchText=!0,this.catchPos.x=a,this.catchPos.y=b,this.catchSize.w=0,this.catchSize.h=0,this.catchRotate=0,this.openEdit(),this.drawCatch()},addSelect:function(a,b){this.context.globalCompositeOperation="source-over",this.mergeCatch(),this.catchSelect=!0,this.catchPos.x=a,this.catchPos.y=b,this.catchSize.w=0,this.catchSize.h=0,this.catchRotate=0,this.drawCatch()},addBucket:function(a){this.context.globalCompositeOperation="source-over",0==a?(this.context.fillStyle=createStyle(this.context,currentFill.fill,0,0,this.divCanvas.width,this.divCanvas.height),this.context.beginPath(),this.context.rect(0,0,this.divCanvas.width,this.divCanvas.height),this.context.fill()):(this.context.fillStyle=createStyle(this.context,currentFill.fill,this.catchPos.x,this.catchPos.y,this.catchSize.w,this.catchSize.h),this.context.beginPath(),this.context.rect(this.catchPos.x,this.catchPos.y,this.catchSize.w,this.catchSize.h),this.context.fill()),this.saveStack()},applySelect:function(a,b){if(this.catchSelect&&null==this.catchImage&&0==this.underApply){var c=this.getCatchRect(!1,!0);if(c.w>0&&c.h>0){this.underApply=!0;var d=this.context.getImageData(c.x,c.y,c.w,c.h);this.context.clearRect(c.x,c.y,c.w,c.h),this.canvasImage.width=c.w,this.canvasImage.height=c.h,this.contextImage.putImageData(d,0,0);var e=new Image;e.onload=function(){project.catchPos.x=c.x,project.catchPos.y=c.y,project.catchImage=this,0==a?project.cropCatch():1==a?project.removeCatch():2==a?project.copyCutClip(b):project.drawCatch(),project.underApply=!1},e.src=this.canvasImage.toDataURL("image/png")}}},openEdit:function(){$("#edText").val(this.catchTextContent),$("#edText").show(),$("#edText").focus()},closeEdit:function(){$("#edText").hide()},formatText:function(){this.catchText&&(this.catchSize.w=100,""!=this.catchTextContent&&(this.catchContext.font=toolProp.font.size+"px "+toolProp.font.family,this.catchSize.w=Math.max(this.catchContext.measureText(this.catchTextContent).width+4,this.catchSize.w)),this.catchSize.h=1.5*toolProp.font.size,$("#edText").is(":visible")&&($("#edText").css({width:this.catchSize.w,height:this.catchSize.h,color:currentFill.fill.color,opacity:toolProp.opacity.text}),$("#edText").css("font-family",toolProp.font.family).css("font-size",toolProp.font.size+"px")))},drawText:function(a){""!=this.catchTextContent&&(a.font=toolProp.font.size+"px "+toolProp.font.family,a.globalAlpha=toolProp.opacity.text,a.lineWidth=toolProp.size.text,a.strokeStyle=createStyle(a,currentFill.fill1,-this.catchSize.w/2,-this.catchSize.h/2,this.catchSize.w,this.catchSize.h),a.fillStyle=createStyle(a,currentFill.fill,-this.catchSize.w/2,-this.catchSize.h/2,this.catchSize.w,this.catchSize.h),a.textBaseline="top",toolProp.size.text>0&&a.strokeText(this.catchTextContent,-this.catchSize.w/2,-this.catchSize.h/2),1==toolProp.fill.text&&a.fillText(this.catchTextContent,-this.catchSize.w/2,-this.catchSize.h/2),a.globalAlpha=1)},drawShape:function(a){if(0!=this.catchSize.w||0!=this.catchSize.h){var b=this.getCatchRect(!1);a.globalAlpha=toolProp.opacity.shape,a.lineWidth=toolProp.size.shape,a.strokeStyle=createStyle(a,currentFill.fill1,-b.w/2,-b.h/2,b.w,b.h),a.fillStyle=createStyle(a,currentFill.fill,-b.w/2,-b.h/2,b.w,b.h),a.beginPath(),setting.shape.type==this.shapes[0]?this.roundRect(a,-b.w/2,-b.h/2,b.w,b.h):setting.shape.type==this.shapes[1]?this.roundRect(a,-b.w/2,-b.h/2,b.w,b.h,toolProp.radius.shape):setting.shape.type==this.shapes[2]?this.ellipse(a,0,0,b.w,b.h):setting.shape.type==this.shapes[3]?this.convex(a,-b.w/2,-b.h/2,b.w,b.h):setting.shape.type==this.shapes[4]?this.concave(a,-b.w/2,-b.h/2,b.w,b.h):setting.shape.type==this.shapes[5]&&this.gear(a,-b.w/2,-b.h/2,b.w,b.h),a.closePath(),toolProp.size.shape>0&&a.stroke(),1==toolProp.fill.shape&&a.fill(),a.globalAlpha=1}},drawEraserOutline:function(a,b){this.catchContext.clearRect(0,0,this.catchCanvas.width,this.catchCanvas.height),this.catchContext.fillStyle="#FFFFFF",this.catchContext.strokeStyle="#404040",this.catchContext.lineWidth=.5,this.catchContext.beginPath();var c=parseInt(toolProp.size.eraser);this.catchContext.rect(parseInt(a-c/2)-.25,parseInt(b-c/2)-.25,c+.5,c+.5),this.catchContext.closePath(),this.catchContext.fill(),this.catchContext.stroke()},drawCatch:function(a){0!=a&&this.formatText(),$("#edText").is(":visible")&&$("#edText").css({left:parseInt(this.catchPos.x+$("#painter").offset().left)+2,top:parseInt(this.catchPos.y+$("#painter").offset().top)+2}),this.catchContext.clearRect(0,0,this.catchCanvas.width,this.catchCanvas.height),this.catchContext.translate(this.catchPos.x+this.catchSize.w/2,this.catchPos.y+this.catchSize.h/2),0!=this.catchRotate&&this.catchContext.rotate(this.catchRotate),this.catchImage?(0==this.catchSelect&&(this.catchContext.globalAlpha=toolProp.opacity.image),this.catchContext.drawImage(this.catchImage,-this.catchSize.w/2,-this.catchSize.h/2,this.catchSize.w,this.catchSize.h),0==this.catchSelect&&(this.catchContext.globalAlpha=1)):this.catchShape?this.drawShape(this.catchContext):this.catchText&&!$("#edText").is(":visible")&&this.drawText(this.catchContext);var b=this.getCatchRect(!0);if(b.x=-b.w/2,b.y=-b.h/2,0!=b.w||0!=b.h){this.catchContext.lineWidth=1,this.catchContext.strokeStyle="#4040FF",this.catchContext.beginPath(),this.catchContext.rect(b.x,b.y,b.w,b.h),this.catchContext.closePath(),this.catchContext.stroke(),this.catchContext.fillStyle="#FFFF00",this.catchPts=[],this.catchPts.push({x:b.x,y:b.y}),this.catchPts.push({x:b.x+b.w/2,y:b.y}),this.catchPts.push({x:b.x+b.w,y:b.y}),this.catchPts.push({x:b.x+b.w,y:b.y+b.h/2}),this.catchPts.push({x:b.x+b.w,y:b.y+b.h}),this.catchPts.push({x:b.x+b.w/2,y:b.y+b.h}),this.catchPts.push({x:b.x,y:b.y+b.h}),this.catchPts.push({x:b.x,y:b.y+b.h/2}),this.catchPts.push({x:b.x+b.w/2,y:b.y-20});for(var c in this.catchPts)this.catchContext.beginPath(),this.catchContext.arc(this.catchPts[c].x,this.catchPts[c].y,5,0,2*Math.PI,!0),this.catchContext.stroke(),this.catchContext.fill()}0!=this.catchRotate&&this.catchContext.rotate(-this.catchRotate),this.catchContext.translate(-this.catchPos.x-this.catchSize.w/2,-this.catchPos.y-this.catchSize.h/2)},getCatchRectWidthBorder:function(a,b,c){var d={x:0,y:0,w:0,h:0},e={w:0,h:0},f=0;return a&&((this.catchShape||this.catchText)&&(f=c),1!=this.catchSelect&&"bucket"!=curTool&&(f+=5)),(this.catchImage||this.catchShape||this.catchText||this.catchSelect||"bucket"==curTool)&&(e.w=this.catchSize.w,e.h=this.catchSize.h),0==e.w&&0==e.h?d:(d.x=Math.min(this.catchPos.x,this.catchPos.x+e.w)-f,d.y=Math.min(this.catchPos.y,this.catchPos.y+e.h)-f,d.w=Math.abs(e.w)+2*f,d.h=Math.abs(e.h)+2*f,1==b&&(d.x=parseInt(d.x),d.y=parseInt(d.y),d.w=parseInt(d.w),d.h=parseInt(d.h)),d)},getCatchRect:function(a,b){return this.getCatchRectWidthBorder(a,b,toolProp.size.shape/2)},getDragType:function(a,b){var c=this.getCatchRect(!0);if(0==c.w&&0==c.h)return 0;var d=0;for(var e in this.catchPts){var f={x:this.catchPts[e].x+this.catchPos.x+this.catchSize.w/2,y:this.catchPts[e].y+this.catchPos.y+this.catchSize.h/2};if(f=rotatePt({x:this.catchPos.x+this.catchSize.w/2,y:this.catchPos.y+this.catchSize.h/2},f,-this.catchRotate),distanceBetween2Points({x:a,y:b},f)<5.01){d=parseInt(e)+2;break}}if(0==d){var f=rotatePt({x:c.x+c.w/2,y:c.y+c.h/2},{x:a,y:b},this.catchRotate);if(f.x<c.x||f.y<c.y||f.x>c.x+c.w||f.y>c.y+c.h)return 0;d=1}return d},startMove:function(a,b){if(this.canMove=this.getDragType(a,b),this.canMove<=0)return 0;var c=this.getCatchRect(!1);return this.catchSaveRect.x=c.x,this.catchSaveRect.y=c.y,this.catchSaveRect.w=c.w,this.catchSaveRect.h=c.h,this.catchSaveRect.h=c.h,this.catchSaveRect.rotate=this.catchRotate,this.catchPos.x=c.x,this.catchPos.y=c.y,this.catchSize.w=c.w,this.catchSize.h=c.h,this.canMove},moving:function(a,b,c){var d=!1;if(this.canMove>0){if(this.catchSelect&&null==this.catchImage)return void this.applySelect();1==this.canMove&&(this.catchPos.x=this.catchSaveRect.x+a,this.catchPos.y=this.catchSaveRect.y+b);var e=this.canMove-2;if(c.shiftKey&&(0==e||2==e||4==e||6==e)){var f=this.catchSaveRect.w/this.catchSaveRect.h;if(a>0&&b>0&&a/b>f||0>b&&0>b&&f>a/b||a>0&&0>b||0==b){var g=Math.abs(b/f);b=0>a?-g:g}else{var g=Math.abs(b*f);a=0>b?-g:g}}(0==e||1==e||2==e)&&(this.catchPos.y=this.catchSaveRect.y+b,this.catchSize.h=this.catchSaveRect.h-b),(0==e||7==e||6==e)&&(this.catchPos.x=this.catchSaveRect.x+a,this.catchSize.w=this.catchSaveRect.w-a),(2==e||3==e||4==e)&&(this.catchSize.w=this.catchSaveRect.w+a),(4==e||5==e||6==e)&&(this.catchSize.h=this.catchSaveRect.h+b),8==e&&(this.catchRotate=this.catchSaveRect.rotate+a/100),d=!0}else if(1==this.catchShape||1==this.catchSelect){if(1==c.shiftKey){var h=Math.max(Math.abs(a),Math.abs(b));a=h*(0>a?-1:1),b=h*(0>b?-1:1)}this.catchSize.w=a,this.catchSize.h=b,d=!0}d&&this.drawCatch(!1)},endMove:function(){!this.catchSelect||null!=this.catchImage||0!=this.catchSize.w&&0!=this.catchSize.h||(this.catchSelect=!1),this.canMove=0}};var canvas2Image=function(){var a=!1,b=document.createElement("canvas");if(b.getContext("2d")&&(a=!0),!a)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var c=!!b.getContext("2d").getImageData,d=!!b.toDataURL,e=!!window.btoa,f="image/octet-stream",g=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},h=function(a){var b="";if("string"==typeof a)b=a;else for(var c=a,d=0;d<c.length;d++)b+=String.fromCharCode(c[d]);return btoa(b)},i=function(a){var b=[],c=a.width,d=a.height;b.push(66),b.push(77);var e=c*d*3+54;b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),b.push(0),b.push(0),b.push(0),b.push(0),b.push(54),b.push(0),b.push(0),b.push(0);var f=[];f.push(40),f.push(0),f.push(0),f.push(0);var g=c;f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256);var i=d;f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256),f.push(1),f.push(0),f.push(24),f.push(0),f.push(0),f.push(0),f.push(0),f.push(0);var j=c*d*3;f.push(j%256),j=Math.floor(j/256),f.push(j%256),j=Math.floor(j/256),f.push(j%256),j=Math.floor(j/256),f.push(j%256);for(var k=0;16>k;k++)f.push(0);var l=(4-3*c%4)%4,m=a.data,n="",o=d;do{for(var p=c*(o-1)*4,q="",r=0;c>r;r++){var s=4*r;
q+=String.fromCharCode(m[p+s+2]),q+=String.fromCharCode(m[p+s+1]),q+=String.fromCharCode(m[p+s])}for(var t=0;l>t;t++)q+=String.fromCharCode(0);n+=q}while(--o);var u=h(b.concat(f))+h(n);return u},j=function(a){document.location.href=a},k=function(a,b){return"data:"+b+";base64,"+a},l=function(a){var b=document.createElement("img");return b.src=a,b},m=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,c),d}return a};return{saveAsPNG:function(a,b,c,e){if(!d)return!1;var g=m(a,c,e),h=g.toDataURL("image/png");return b?l(h):(j(h.replace("image/png",f)),!0)},saveAsJPEG:function(a,b,c,e){if(!d)return!1;var g=m(a,c,e),h="image/jpeg",i=g.toDataURL(h);return 5!=i.indexOf(h)?!1:b?l(i):(j(i.replace(h,f)),!0)},saveAsBMP:function(a,b,d,h){if(!c||!e)return!1;var n=m(a,d,h),o=g(n),p=i(o);return b?l(k(p,"image/bmp")):(j(k(p,f)),!0)}}}();!function(){function a(a){var b,d,e,f,g,h;for(e=a.length,d=0,b="";e>d;){if(f=255&a.charCodeAt(d++),d==e){b+=c.charAt(f>>2),b+=c.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(d++),d==e){b+=c.charAt(f>>2),b+=c.charAt((3&f)<<4|(240&g)>>4),b+=c.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(d++),b+=c.charAt(f>>2),b+=c.charAt((3&f)<<4|(240&g)>>4),b+=c.charAt((15&g)<<2|(192&h)>>6),b+=c.charAt(63&h)}return b}function b(a){var b,c,e,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=d[255&a.charCodeAt(g++)];while(h>g&&-1==b);if(-1==b)break;do c=d[255&a.charCodeAt(g++)];while(h>g&&-1==c);if(-1==c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(e=255&a.charCodeAt(g++),61==e)return i;e=d[e]}while(h>g&&-1==e);if(-1==e)break;i+=String.fromCharCode((15&c)<<4|(60&e)>>2);do{if(f=255&a.charCodeAt(g++),61==f)return i;f=d[f]}while(h>g&&-1==f);if(-1==f)break;i+=String.fromCharCode((3&e)<<6|f)}return i}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);window.btoa||(window.btoa=a),window.atob||(window.atob=b)}();
